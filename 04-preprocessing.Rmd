# Preprocessing 
<!-- will merge with 03 import data section that is already written--> 

## Part One 
<!-- not sure what would be the best name for these headers yet; want to imply the first four are sequential --> 
<!-- need to specify what type of data is being imported -- iEEG recording info) --> 

<font size="5"> **Step #1: Import Signals** </font>

<!-- have labeled screenshot for each step similar to the one in 04-preprocessing--> 
Now that you have installed and gotten started with RAVE, you can proceed to importing your iEEG data into the software so that it can be preprocessed and used in future modules.

**Step 1.1:** Select project & subject

First, use the drop down menu to **specify which project** you want the cleaned subject data to be stored in. If you wish to create a new project, select "New Project" from the drop down menu and indicate your desired project name. Note that by default, this project folder will be created within the `rave_data` folder of the data directory (`data_dir`), in a new folder for your subject. 

Next, use the drop down menu to **select the code for the subject** whose data you want to import. Note that a subject's data should be stored in its own folder within the raw directory (`raw_dir` folder) within the`rave_data` folder. 

Click the **"Create Subject"** button to proceed to the next step. 

**Step 1.2:** Format & session blocks

RAVE defines a block/session as a period of continuous electrode recording. Here, you should first **select the blocks** that correspond to the trials you want to analyze. 

Note that when you select a block, a preview of the files it contains will pop-up to the right. This feature helps you check that the way you've stored your data is consistent with the file type you've selected. 

Then, **specify the file format** your iEEG data is stored in. RAVE currently supports four file formats: 

* .mat/.h5 file per electrode per block 
* single .mat/.h5 file per block 
* single EDF(+) file per block 
* single BrainVision file 

Note that when you select a format from the drop down, a brief description of the specific format will pop-up underneath the menu. For more information on these file types, visit the Q&A at [Importing Data](#importing-data)

<!-- maybe cross link each of these file formats to a question in the Q&A session so that if someone wants to learn more about a given file format, they can do so without cluttering up this section. or should i give the description right next to the bullet point --> 

**Step 1.3:** Channel information

RAVE equates a channel to an electrode. Set the following specifications for your channels:  

<!-- this isn't exactly true, so come back later to fix definition --> 

* **Data file:** 

* **Channel numbers:** Indicate the electrodes you wish to analyze. It is recommended that you run the preprocessing steps on all electrodes at once. Note that RAVE can automatically detect potential electrodes based on the specified blocks and file type; this suggestion is displayed at the bottom of the panel. 

* **Physical unit:** Indicate the units you wish to use to measure voltage.

* **Sample rate:** Indicate the rate of your iEEG recording equipment; this value will determine the rate at which the preprocessing will be run.

Now, select the **Validate & Import** button to validate your data. A pop-up will soon appear asking if you are ready to import your data. Please double check all the information you entered is correct, and then select the **Import Data** button to proceed. You will see a progress bar in the bottom left corner. 

<!-- in this paragrraph, make sure to add a note about the skip validate & import button / when it can be used --> 

A pop-up will soon appear indicating that you have successfully imported your subject data into RAVE! You can now use the menu on the left side of the screen to select the first preprocessing module, notch filter. 

<font size="5"> **Step #2: Notch Filter** </font>
<!-- add very brief description of what this section is for first; essentially it filters out extra noise without disruption to the rest of the signal. it does this by minimizing signals within a narrow bandwidth; the rest of the signal is not disrupted because it's not in the bandwidth. a bandwidth is a range of frequencies within a band. a common reason for applying it is because EEG recording setups often include an amplifier. 
AC power grid in US is 60 Hz, issue is the EEG recording equipment will pick up on that and we don't want those signals because they're not from the brain, they're external. so the idea is to remove that data. stopband = a band of frequencies that are reduced by a filter. width is essentially the amount of frequencies --> 
<!-- how do you create notch filter? probably put brief explanation here and then have a question in Q&A where they can learn more with any outside links. "The easiest is to create a notch filter, which basically involves taking the FFT of the signal, zeroing out the Fourier coefficients at/around 50 Hz (best to use gentle slopes to minimize introducing artifacts resulting from sharp edges), then taking the inverse FFT."--> 
<!-- "calculation of multiples of a base frequency" -- why do you need to do multiples? --> 

**What is a notch filter?** A notch filter blocks a given frequency or a narrow range of frequencies (aka a "bandwidth") from a signal without affecting the rest of that signal. It is often used to minimize line noise interference in raw iEEG data, which helps ensure that future analyses only consider actual brain data. A common source of this interference is the amplifier used in recording set-ups to convert electrode signals into a form readable by the computer. This interference is commonly introduced at 60 Hz, since that is the standard frequency used in the North American electrical grid system. 

To apply the notch filter, RAVE performs a fast fourier transform (FFT) of the signal. To learn more about FFT, visit the Q&A section at [Notch Filter](#notch-filter).

<!-- https://terpconnect.umd.edu/~toh/spectrum/FourierFilter.html, https://towardsdatascience.com/fast-fourier-transform-937926e591cb --> 

To apply the notch filter to your data, follow the steps below. 

<!-- clarify block --> 

Begin in the **Data Selection** window to <u> specify which data you want to perform the notch filter on </u>. Use the drop down to indicate the desired project and subject. Note that you can press the **Sync from [Import LFP] module** link to automatically select the project and subject that you just imported in the Import Signals module. 

![Data Selection](static/image/NFImport.png)
<!-- make sure to add in the Q&A what happens if you get errors in this case --> 

Proceed by selecting the **Load Subject** button. A new screen will load with three panels: Filter Settings, Inspection, and Notch. Refer to the following screenshot for guidance. 

![Sample Notch Filter Screen](static/image/NotchFilter.png)

**Filter Settings:** Begin my indicating your desired configurations for the **filter(s)**.

* <u>Base frequency</u> refers to the frequency introduced by the amplifier that you want to remove. By default, this is set as 60 Hz as that is the frequency introduced by most iEEG amplifiers.  

* <u>x Times</u> sets the multipliers of the base frequency you want removed by the filter. This feature allows you to account for harmonics (waves with frequencies that are positive integer multiples of the base frequency), which result because the signal from the amplifier is not a pure sine wave when undergoing FFT analysis. By default, this value is set as "1,2,3" based on the harmonics that commonly result in iEEG recording set-ups. This default means that 60 Hz (base frequency * 1), 120 Hz (base frequency * 2), 180 Hz (base frequency * 3) are the frequencies that the notch filter will remove. 

* <u>+- Bandwidth (Hz)</u> refers to how wide you wish to make each filter; a higher number will remove a wider range of frequencies whereas a lower number will remove a narrower range of frequencies. You should enter one number for each filter you have. By default, this value is set to 1,2,2 -- in other words, your filters will remove the bandwidths **59 - 61 Hz** (aka 60 Hz +/- 1), **118 - 122 Hz** (aka 120 Hz +/- 2), **178 - 182 Hz** (aka 180 Hz +/- 2) respectively. 

<!-- specify why they may wish to do this // how exactly do you wish to set it to this --> 

Based on these configurations, the bottom of the panel will automatically display a summary of how many filters you have and the bandwidths each will remove. 

Click the blue **Apply Notch Filters** button to apply the filters to your data. A pop-up will appear showing a summary of your configurations. Click "Confirm" to proceed. 

<!-- add transition --> 
<!-- add we can not find any imported electrode message on notch -- inspect signals screen --> 

**Inspection:** Controls settings of the figures displayed in the Notch: Inspect Signals panel located to the right. 

Use the <u>block</u> and <u>electrode</u> drop down menus to select the data you wish to display in the Notch: Inspect Signals panel. You can use the `previous` and `next` buttons to easily switch between which electrode you're viewing within a selected recording session.  

* The <u>window length</u> slider controls the power range displayed for the Welch periodograms. The more you move the slider to the right, the wider the dB range on the y-axis. 

<!-- include by what amount changing the window length corrresponds to --> 

* The <u>frequency limit</u> slider controls the frequency range for the Welch periodograms. The more you move the slider to the right, the higher the frequencies that will be displayed on the x-axis. 

* The <u>number of histogram bins</u> slider controls how wide the voltage ranges on the horizontal axis of the histogram are, where each bin represents a vertical bar on the graph. Choosing a larger number will create narrower voltage ranges and thus more vertical bars, whereas choosing a smaller number will create wider voltage ranges and thus fewer vertical bars. Moving the slider can give you a more precise look at which voltages are most represented in the electrode signal. 

**Notch: Inspect Signals:** Displays ***raw and filtered iEEG signals** for each channel whose data was imported 

<!-- Refer to the following screenshot for further guidance. label purpose of each section --> 
<!-- note: they need to specify the configurations for the notch filter, and then --> 

* The top <u>Local Field Potential Graph</u> plots voltage versus time in seconds to show the raw signal that was recorded from the selected electrode. The red lines on the graph reflect the normalization 

<!--what do the red lines indicate? // negative voltage -- current flow in opposite direction than potential difference // LFP a summation signal of excitatory and inhibitory dendritic potentials from a large number of neurons in the neighborhood of the recording site. --> 
* The leftmost <u>Welch Periodogram </u> estimates the power of the signal at its component frequencies. Before applying the notch filter, only the original graph will be shown in grey. After you've applied the notch filter, the filtered signal will be shown in red; you should visibly see the power of the signal reduced at the base and harmonic frequencies. To learn more about the calculation of the Welch Periodogram, visit the Q&A at [Notch Filter](#notch-filter).

* The center <u>Welch Periodogram</u> is the same as the leftmost periodogram, except it is transformed to have a logarithmic x-axis. This graph makes viewing the signals at lower frequencies easier. 

* The <u>Histogram Original</u> plots frequency on the vertical axis and voltage on the horizontal axis to depict how often each range of voltages occurs in the signal. 

<!-- perhaps specify what each graph can be used for / purpose of changing the sliders -- e.g. number of histogram bins ... making it larger would allow for more precise look at which voltages are included in the siggnal --> 

If you wish to download these figures, simply click the **Download as PDF** link at the bottom of the Inspection panel. This will generate a PDF file in a new tab with a slide for each electrode within each block. 

<!-- add note that it is always possible to lose cerebral data with the filter --> 

<font size="5"> **Step #3: Wavelet** </font>

Once you click the wavelet tab on the left menu, a data selection window will appear for you to select the project and subject whose data you wish to apply wavelet decomposition to. You can once again click the "sync from [import LFP] module" to automatically select the subject you just imported. Note: You must have applied the notch filter to your selected subject before trying to apply the wavelet transformation.  

After selecting the "Load Subject" button, a new screen will load with two panels: Wavelet Settings and Wavelet Kernel. Refer to the following screenshot for guidance. 

![Sample Wavelet Decomposition Screen](static/image/Wavelet.png)

Wavelet decomposition is a type of time frequency analysis that is used for non-stationary signals (i.e. properties change over time), like that of iEEG. It separates the signal into differing frequency and phase components, which is helpful because signals in the brain are very dynamic. This process makes it so that changes in the signal's power spectra can be visualized across both frequency and time. 

To learn more about how wavelet transform works, visit the Q&A at [Wavelet](#wavelet).

<!-- in Q&A compare to time analysis --> 

In this module, RAVE can: 
- downsample the signal before running the wavelet, if desired  
- run a wavelet on each block in the selected subject's folder 
- downsample the wavelet coefficients to 100.0 Hz to reduce the amount of space needed to save the information onto your computer's disk 

**Wavelet Settings:** 

<!-- why did you remove option to select electrodes like old version --> 
Begin by setting the basic configurations: 

* In <u>Power sample rate</u>, enter the rate used in the iEEG recording experiment. By default, this is set to 100 Hz. 

<!-- explain default; is this the same as the sample rate set in importing signals? --> 

* The <u>Down-sample before wavelet </u> drop down menu will allow you to select a factor of 1, 2, 4, or 8 to use to reduce the sample rate. Reducing the sampling rate is commonly done to run the wavelet transform faster and use less of the computer's disk space. Note that selecting 1 means you do not want to reduce the sampling rate, and that reducing the rate by a higher factor allows for analyzing a greater frequency range. 

<!-- list what it is set to by default; how do they know which number specifically to pick? or things to consider --> 

If you wish to reduce the amount of time it takes to run the wavelet, please select the **use single float precision** checkbox. Please note, though, that this option will also _____. 
<!-- what is the downside to using this? i.e. why wouldn't someone want to speed up the process? I'm assuming it takes away from precision? also explain why this increases speed --> 

Proceed by setting your frequency and cycle configurations: 

* The <u> select method to generate wavelet parameters </u> drop down menu allows you to ____. By default, it is set to "built in" to allow you to set your frequency and cycle configurations using the RAVE interface. If you select "upload preset," an upload button will appear. (Note that your preset configurations should be in the form of a csv with two columns, frequency and cycles. You can proceed straight to running the wavelet via the blue "run wavelet" button if you upload your own preset.) 

* Use the <u> frequency range </u> slider to select the range of frequencies you wish to decompose with the wavelet. 

* Use the <u> frequency step size </u> slider 

* Use the <u> wavelet cycles </u> slider to choose the range of cycles you wish to use in the transform. Note that a larger number of cycles will lead to more precise frequency analysis, whereas a smaller number of cycles will lead to more precise temporal analysis. 

**Wavelet Kernel:** 

* The <u> Wavelet Kernels (Real & Imaginary) </u> graph 

* The <u> Wavelet Length | Frequency </u> graph 

* The <u> Wavelet Cycle | Frequency </u> graph 

If you wish to download the kernel parameters, click the blue **download kernel parameters** link at the bottom of the window. This will generate a csv file with each frequency and its corresponding number of cycles. 

When finished setting the configurations and reviewing the figures, select the blue **Run Wavelet** button. As shown below, a pop-up will appear on the screen asking you to confirm the subject, frequencies, # of cycles, and precision that you selected for the wavelet transformation. Click "confirm" to proceed, or "confirm and run in background" if you wish to continue using RAVE during the decomposition process. Note that this process can take up to 30 minutes; progress bars for each task will be displayed in the lower right corner. 

![Sample Wavelet Decomposition Confirmation Window](static/image/WaveletConfirmation.png)

The process is completed if a "success" pop-up appears. You can now proceed to the next module, referencing! 

<font size="5"> **Step #4: Reference Signals** </font>
Common average referencing 

--- 

## Part Two

<font size="5"> **Surface Registration Localization** </font>

--- 

## Part Three

<font size="5"> **Generate Epoch** </font>
